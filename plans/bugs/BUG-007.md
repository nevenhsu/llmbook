# Bug 記錄 - BUG-007

## 基本資訊

| 項目 | 內容 |
|------|------|
| **Bug ID** | BUG-007 |
| **發現日期** | 2026-02-08 |
| **嚴重程度** | P1 - 嚴重 |
| **測試項目** | 首頁貼文排序邏輯 |
| **標題** | Hot/New/Top/Rising 邏輯不明 |
| **狀態** | Open |

---

## 問題描述

首頁貼文排序邏輯（Hot/New/Top/Rising）寫在 page 元件中，程式碼混亂且難以理解。各排序算法的區分邏輯沒有清楚標註，目前只有 5 篇貼文且 score 都為 0，無法看出差異。

---

## 重現步驟

1. 訪問首頁 `/`
2. 切換 Hot/New/Top/Rising 排序
3. 觀察貼文順序變化

---

## 期望結果

1. **程式碼結構**: 貼文取得邏輯應從 page 分離
   - 建議移到自定義 hook（如 `useFeedPosts`）
   - 或移到獨立的 utility 函數

2. **邏輯標註**: 每種排序的算法要清楚註解
   - Hot: 應該是基於時間衰減的熱門算法
   - Top: 基於總分數
   - Rising: 近期快速獲得投票的貼文
   - New: 最新發布

3. **資料驗證**: 需要測試資料來驗證排序效果

---

## 實際結果

- 程式碼混亂，全寫在 page 中
- 只有 5 篇貼文，score 都為 0
- 無法看出各排序的差異
- 不清楚各排序的具體算法

---

## 相關程式碼

**頁面**: `src/app/(pages)/page.tsx` 或 `src/app/page.tsx`

需要重構：
1. 分離資料取得邏輯
2. 清楚標註各排序算法
3. 可能需要新增 seed 資料來測試

---

## 修復建議

### 1. 分離邏輯

```typescript
// src/hooks/useFeedPosts.ts
export function useFeedPosts(sort: SortType, timeRange?: TimeRange) {
  // 分離的資料取得邏輯
}

// src/lib/sorting-algorithms.ts
export const sortingAlgorithms = {
  hot: (posts) => { /* 熱門算法 */ },
  top: (posts, timeRange) => { /* 最高分算法 */ },
  rising: (posts) => { /* 上升算法 */ },
  new: (posts) => { /* 最新算法 */ },
};
```

### 2. 算法註解

```typescript
/**
 * Hot 排序算法
 * 基於 Reddit 的熱門算法，考慮：
 * - 投票分數 (score)
 * - 時間衰減 (新貼文有優勢)
 * - 評論數量 (間接影響）
 */
```

---

## 環境資訊

- **瀏覽器**: Chrome
- **設備**: 桌面

---

## 備註

- 需要確認目前的排序算法實作
- 可能需要新增更多測試資料
- 建議參考 Reddit 的排序算法文檔

---

## 完整修復需求

### 1. 程式碼重構
- 分離排序邏輯到獨立檔案
- 清楚標註各算法公式和參數

### 2. 測試資料 ✅
**已創建**: `supabase/seeds/010_test_sorting_posts.sql`

包含 **25 篇測試貼文**，具備以下變異：

| 屬性 | 變異範圍 |
|------|---------|
| Score | -5 到 +55 |
| Created At | 5 分鐘到 28 天前 |
| Comment Count | 0 到 45 |
| 標籤 | [NEW], [HOT], [TOP], [RISING], [CONTROVERSIAL], [OLD], [MIXED] |

**測試貼文分類**：
- **NEW (5篇)**: 5分鐘到5小時前，score 0-5
- **HOT (5篇)**: 6-18小時前，高互動 score 8-45
- **TOP (5篇)**: 2-20天前，高分數 score 28-55
- **RISING (3篇)**: 快速獲得投票
- **MIXED (7篇)**: 邊界案例（負分、舊文高分等）

### 3. 可能缺失的欄位
需檢查 posts 表是否包含：
- ✅ `score` - 已有，net score (upvotes - downvotes)
- ✅ `comment_count` - 已有，透過 trigger 自動更新
- ❓ `last_vote_at` - 可能需要，用於 Rising 算法計算「短期內投票速度」

**Rising 算法建議**：
如果要做真正的 Rising，需要：
- 方案 A: 添加 `last_vote_at` 欄位，每次投票時更新
- 方案 B: 查詢 votes 表，計算最近 24 小時內的投票數
- 方案 C: 簡化版 Rising = 新貼文 + 高 score 增長率

---

## 更新記錄

| 日期 | 動作 | 說明 |
|------|------|------|
| 2026-02-08 | 創建 | 初始記錄 |
| 2026-02-08 | 更新 | 補充測試資料和欄位需求 |
| 2026-02-08 | 創建 Seed | 新增 010_test_sorting_posts.sql，25篇測試貼文 |
