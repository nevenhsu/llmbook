# Bug 記錄 - BUG-009

## 基本資訊

| 項目 | 內容 |
|------|------|
| **Bug ID** | BUG-009 |
| **發現日期** | 2026-02-08 |
| **嚴重程度** | P0 - 致命 |
| **測試項目** | 評論功能 |
| **標題** | Comment 後頁面當機 - DOMPurify 錯誤 |
| **狀態** | Open |

---

## 問題描述

在帖子頁面 `/posts/ab9e4c74-674d-446f-a6af-731f4f5e124b` 新增評論後，頁面出現 Runtime Error，導致應用程式崩潰。

**錯誤訊息**：
```
Runtime Error
{imported module ./nodemodules/dompurify/dist/purify.es.mjs}.default.sanitize is not a function
```

---

## 重現步驟

1. 訪問帖子頁面 `/posts/ab9e4c74-674d-446f-a6af-731f4f5e124b`
2. 在評論輸入框輸入內容
3. 點擊發布評論
4. 觀察頁面變化

---

## 期望結果

1. 評論成功發布
2. 頁面正常更新
3. 新評論立即顯示在列表中
4. 沒有錯誤訊息

---

## 實際結果

1. 頁面突然空白
2. 之後才顯示新評論
3. 但出現 Runtime Error
4. 應用程式崩潰

---

## 錯誤分析

**錯誤類型**: `TypeError: sanitize is not a function`

**可能原因**：
1. DOMPurify ESM 匯出方式問題
2. Next.js 伺服器端渲染相容性問題
3. 版本衝突或不正確的匯入方式

**懷疑檔案**：
- `src/lib/dompurify.ts` 或類似淨化工具
- 使用 DOMPurify 的評論渲染元件

---

## 相關程式碼

需要檢查：
1. DOMPurify 的匯入方式
2. 評論內容渲染邏輯
3. 是否在 Server Component 中使用了 DOMPurify（應該只在 Client Component 使用）

---

## 修復建議

### 根本原因
DOMPurify 3.x 在 Next.js 16 + React 19 的 ESM/CJS 混用環境中可能出現 `sanitize is not a function` 錯誤。這是因為 DOMPurify 的 ESM 建置與 Next.js bundler 的相容性問題。

### 方案 1: 使用 isomorphic-dompurify（推薦）

安裝並使用 `isomorphic-dompurify`，它專門解決 SSR 環境的問題：

```bash
npm install isomorphic-dompurify
```

修改兩個檔案：

**SafeHtml.tsx**:
```typescript
"use client";

import DOMPurify from 'isomorphic-dompurify';

interface SafeHtmlProps {
  html: string;
  className?: string;
}

export default function SafeHtml({ html, className = '' }: SafeHtmlProps) {
  return (
    <div 
      className={className}
      dangerouslySetInnerHTML={{ __html: DOMPurify.sanitize(html) }}
    />
  );
}
```

**CommentItem.tsx**:
```typescript
"use client";

import DOMPurify from 'isomorphic-dompurify';

// ... 其他匯入保持不變

// 將
// import DOMPurify from 'dompurify';
// 改為
import DOMPurify from 'isomorphic-dompurify';

// 使用方式不變
dangerouslySetInnerHTML={{ __html: comment.is_deleted ? '[deleted]' : DOMPurify.sanitize(comment.body) }}
```

### 方案 2: 延遲初始化（不推薦）

```typescript
"use client";

import DOMPurify from 'dompurify';
import { useEffect, useState } from 'react';

export default function SafeHtml({ html, className = '' }) {
  const [sanitized, setSanitized] = useState('');

  useEffect(() => {
    if (typeof window !== 'undefined') {
      setSanitized(DOMPurify.sanitize(html));
    }
  }, [html]);

  return <div className={className} dangerouslySetInnerHTML={{ __html: sanitized }} />;
}
```

### 方案 3: 動態匯入

```typescript
"use client";

import { useEffect, useState } from 'react';

export default function SafeHtml({ html, className = '' }) {
  const [SanitizedHtml, setSanitizedHtml] = useState<any>(null);

  useEffect(() => {
    import('dompurify').then((DOMPurify) => {
      setSanitizedHtml(() => (content: string) => DOMPurify.default.sanitize(content));
    });
  }, []);

  return (
    <div 
      className={className}
      dangerouslySetInnerHTML={{ __html: SanitizedHtml ? SanitizedHtml(html) : '' }}
    />
  );
}
```

---

## 執行步驟

1. **安裝 isomorphic-dompurify**：
   ```bash
   npm install isomorphic-dompurify
   npm install -D @types/isomorphic-dompurify
   ```

2. **更新匯入**：
   - `src/components/ui/SafeHtml.tsx`
   - `src/components/comment/CommentItem.tsx`

3. **測試**：發布評論確認錯誤已修復

---

## 環境資訊

- **瀏覽器**: Chrome
- **設備**: 桌面
- **框架**: Next.js 16.1.6

---

## 截圖/錄影

待補

---

## 備註

- 這是一個嚴重的功能性問題
- 影響用戶發表評論的體驗
- 需要優先修復
- 可能影響其他需要 HTML 淨化的功能

---

## 更新記錄

| 日期 | 動作 | 說明 |
|------|------|------|
| 2026-02-08 | 創建 | 初始記錄 |
