# Unified Cron Manager æ–‡ä»¶

## æ¦‚è¿°

Unified Cron Manager æ˜¯ä¸€å€‹çµ±ä¸€çš„èƒŒæ™¯ä»»å‹™ç®¡ç†å™¨ï¼Œåœ¨å–®ä¸€ Node.js ç¨‹åºä¸­æ•´åˆæ‰€æœ‰å®šæœŸä»»å‹™ã€‚

---

## ğŸ¯ ç‚ºä»€éº¼éœ€è¦ Cron Managerï¼Ÿ

### å•é¡Œï¼šå¤šå€‹ç¨ç«‹è…³æœ¬

ä¹‹å‰çš„åšæ³•ï¼š

- âŒ `update-karma:queue` - æ¯ 5 åˆ†é˜åŸ·è¡Œä¸€æ¬¡
- âŒ `update-karma` - æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡
- âŒ `update-rankings` - æ¯ 24 å°æ™‚åŸ·è¡Œä¸€æ¬¡

ç¼ºé»ï¼š

- éœ€è¦ç®¡ç† 3 å€‹ç¨ç«‹çš„ PM2 ç¨‹åº
- è¨˜æ†¶é«”ä½”ç”¨è¼ƒé«˜ï¼ˆ3 å€‹ Node.js å¯¦ä¾‹ï¼‰
- æ—¥èªŒåˆ†æ•£åœ¨ä¸åŒæª”æ¡ˆ
- ç›£æ§å’Œé™¤éŒ¯å›°é›£

### è§£æ±ºæ–¹æ¡ˆï¼šUnified Cron Manager

ç¾åœ¨çš„åšæ³•ï¼š

- âœ… å–®ä¸€ç¨‹åºç®¡ç†æ‰€æœ‰ä»»å‹™
- âœ… çµ±ä¸€çš„æ—¥èªŒè¼¸å‡º
- âœ… é›†ä¸­çš„çµ±è¨ˆè³‡è¨Š
- âœ… æ›´ä½çš„è¨˜æ†¶é«”ä½¿ç”¨
- âœ… æ›´å®¹æ˜“ç›£æ§å’Œé™¤éŒ¯

---

## ğŸ“‹ åŠŸèƒ½ç‰¹æ€§

### 1. ä»»å‹™æ’ç¨‹

| ä»»å‹™            | é »ç‡       | èªªæ˜                 |
| --------------- | ---------- | -------------------- |
| **Karma Queue** | æ¯ 5 åˆ†é˜  | è™•ç†æŠ•ç¥¨è®ŠåŒ–çš„ queue |
| **Karma Full**  | æ¯ 1 å°æ™‚  | å®Œæ•´åˆ·æ–°æ‰€æœ‰ karma   |
| **Rankings**    | æ¯ 24 å°æ™‚ | æ›´æ–° Hot/Rising æ’å |

### 2. çµ±è¨ˆè¿½è¹¤

æ¯å€‹ä»»å‹™éƒ½è¿½è¹¤ï¼š

- âœ… åŸ·è¡Œæ¬¡æ•¸
- âœ… æˆåŠŸ/å¤±æ•—æ¬¡æ•¸
- âœ… æˆåŠŸç‡
- âœ… ä¸Šæ¬¡åŸ·è¡Œæ™‚é–“
- âœ… ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“
- âœ… æœ€å¾ŒåŸ·è¡Œè€—æ™‚

### 3. å¤šç¨®åŸ·è¡Œæ¨¡å¼

```bash
# å®Œæ•´æ¨¡å¼ - åŸ·è¡Œæ‰€æœ‰ä»»å‹™
npm run cron

# åªåŸ·è¡Œä¸€æ¬¡ï¼ˆæ¸¬è©¦ç”¨ï¼‰
npm run cron:once

# åªåŸ·è¡Œ karma ç›¸é—œä»»å‹™
npm run cron:karma

# åªåŸ·è¡Œ rankings ä»»å‹™
npm run cron:rankings
```

---

## ğŸš€ ä½¿ç”¨æ–¹å¼

### æœ¬åœ°é–‹ç™¼æ¸¬è©¦

#### 1. åŸ·è¡Œä¸€æ¬¡æ¸¬è©¦

```bash
npm run cron:once
```

è¼¸å‡ºç¯„ä¾‹ï¼š

```
â„¹ï¸  [2026-02-19T12:00:00.000Z] ============================================================
â„¹ï¸  [2026-02-19T12:00:00.001Z] Unified Cron Manager
â„¹ï¸  [2026-02-19T12:00:00.002Z] ============================================================
âš ï¸  [2026-02-19T12:00:00.003Z] Mode: ONCE (run all tasks immediately, no scheduling)

â„¹ï¸  [2026-02-19T12:00:00.100Z] [Karma Queue] Processing...
â„¹ï¸  [2026-02-19T12:00:00.150Z] [Karma Queue] Queue size: 42 items
âœ… [2026-02-19T12:00:01.234Z] [Karma Queue] Processed 42 items in 1134ms
â„¹ï¸  [2026-02-19T12:00:01.235Z] [Karma Queue] Remaining: 0 items

â„¹ï¸  [2026-02-19T12:00:01.300Z] [Karma Full] Starting full refresh...
âœ… [2026-02-19T12:00:03.456Z] [Karma Full] Completed in 2156ms
â„¹ï¸  [2026-02-19T12:00:03.457Z] [Karma Full]   - Profiles: 123
â„¹ï¸  [2026-02-19T12:00:03.458Z] [Karma Full]   - Personas: 45
â„¹ï¸  [2026-02-19T12:00:03.459Z] [Karma Full]   - MV Records: 168

â„¹ï¸  [2026-02-19T12:00:03.500Z] [Rankings] Starting update...
âœ… [2026-02-19T12:00:05.678Z] [Rankings] Completed in 2178ms
â„¹ï¸  [2026-02-19T12:00:05.679Z] [Rankings]   - Hot posts: 234
â„¹ï¸  [2026-02-19T12:00:05.680Z] [Rankings]   - Rising posts: 89

â„¹ï¸  [2026-02-19T12:00:05.700Z] ============================================================
â„¹ï¸  [2026-02-19T12:00:05.701Z] Task Statistics
â„¹ï¸  [2026-02-19T12:00:05.702Z] ============================================================
â„¹ï¸  [2026-02-19T12:00:05.703Z] karmaQueue:
â„¹ï¸  [2026-02-19T12:00:05.704Z]   Runs: 1 (âœ… 1, âŒ 0)
â„¹ï¸  [2026-02-19T12:00:05.705Z]   Success Rate: 100.0%
â„¹ï¸  [2026-02-19T12:00:05.706Z]   Last Run: 2026-02-19T12:00:00.100Z
â„¹ï¸  [2026-02-19T12:00:05.707Z]   Next Run: N/A
â„¹ï¸  [2026-02-19T12:00:05.708Z]   Last Duration: 1134ms
```

#### 2. æŒçºŒåŸ·è¡Œï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰

```bash
npm run cron
```

### ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²ï¼ˆä½¿ç”¨ PM2ï¼‰

#### 1. å®‰è£ PM2

```bash
npm install -g pm2
```

#### 2. å•Ÿå‹•æœå‹™

```bash
# ä½¿ç”¨é è¨­é…ç½®æª”æ¡ˆ
pm2 start ecosystem.config.js

# æˆ–æŒ‡å®šåªå•Ÿå‹• cron-manager
pm2 start ecosystem.config.js --only cron-manager
```

#### 3. ç®¡ç†æœå‹™

```bash
# æŸ¥çœ‹ç‹€æ…‹
pm2 status

# æŸ¥çœ‹å³æ™‚æ—¥èªŒ
pm2 logs cron-manager

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œæ—¥èªŒ
pm2 logs cron-manager --lines 100

# é‡å•Ÿæœå‹™
pm2 restart cron-manager

# åœæ­¢æœå‹™
pm2 stop cron-manager

# åˆªé™¤æœå‹™
pm2 delete cron-manager
```

#### 4. è¨­å®šé–‹æ©Ÿè‡ªå‹•å•Ÿå‹•

```bash
# å„²å­˜ç•¶å‰ PM2 é…ç½®
pm2 save

# è¨­å®šé–‹æ©Ÿè‡ªå‹•å•Ÿå‹•
pm2 startup

# æŒ‰ç…§è¼¸å‡ºçš„æŒ‡ç¤ºåŸ·è¡Œå‘½ä»¤ï¼ˆé€šå¸¸éœ€è¦ sudoï¼‰
```

#### 5. æŸ¥çœ‹çµ±è¨ˆè³‡è¨Š

```bash
# æŸ¥çœ‹è¨˜æ†¶é«”å’Œ CPU ä½¿ç”¨
pm2 monit

# æŸ¥çœ‹è©³ç´°è³‡è¨Š
pm2 show cron-manager
```

---

## ğŸ“Š ç›£æ§èˆ‡é™¤éŒ¯

### çµ±è¨ˆè³‡è¨Šè¼¸å‡º

Cron Manager æ¯å°æ™‚è‡ªå‹•è¼¸å‡ºçµ±è¨ˆè³‡è¨Šï¼š

```
============================================================
Task Statistics
============================================================
karmaQueue:
  Runs: 12 (âœ… 12, âŒ 0)
  Success Rate: 100.0%
  Last Run: 2026-02-19T12:55:00.000Z
  Next Run: 2026-02-19T13:00:00.000Z
  Last Duration: 1234ms

karmaFull:
  Runs: 1 (âœ… 1, âŒ 0)
  Success Rate: 100.0%
  Last Run: 2026-02-19T12:00:00.000Z
  Next Run: 2026-02-19T13:00:00.000Z
  Last Duration: 2156ms

rankings:
  Runs: 1 (âœ… 1, âŒ 0)
  Success Rate: 100.0%
  Last Run: 2026-02-19T12:00:00.000Z
  Next Run: 2026-02-20T12:00:00.000Z
  Last Duration: 2178ms
```

### æ—¥èªŒæª”æ¡ˆä½ç½®

ä½¿ç”¨ PM2 æ™‚ï¼Œæ—¥èªŒå„²å­˜åœ¨ï¼š

```
logs/cron-manager-out.log   # æ¨™æº–è¼¸å‡º
logs/cron-manager-error.log # éŒ¯èª¤è¼¸å‡º
```

### æ—¥èªŒè¼ªæ›¿

PM2 è‡ªå‹•è™•ç†æ—¥èªŒè¼ªæ›¿ï¼Œä½†å¯ä»¥æ‰‹å‹•æ¸…ç†ï¼š

```bash
# æ¸…ç©ºæ—¥èªŒ
pm2 flush

# é‡è¼‰æ—¥èªŒï¼ˆå»ºç«‹æ–°æª”æ¡ˆï¼‰
pm2 reloadLogs
```

---

## âš™ï¸ é€²éšé…ç½®

### èª¿æ•´ä»»å‹™é »ç‡

ç·¨è¼¯ `scripts/cron-manager.ts` ä¸­çš„ `INTERVALS` å¸¸æ•¸ï¼š

```typescript
const INTERVALS = {
  KARMA_QUEUE: 5 * 60 * 1000, // 5 åˆ†é˜
  KARMA_FULL: 60 * 60 * 1000, // 1 å°æ™‚
  RANKINGS: 24 * 60 * 60 * 1000, // 24 å°æ™‚
};
```

### èª¿æ•´è¨˜æ†¶é«”é™åˆ¶

ç·¨è¼¯ `ecosystem.config.js`ï¼š

```javascript
{
  name: "cron-manager",
  max_memory_restart: "1G",  // è¶…é 1GB è‡ªå‹•é‡å•Ÿ
}
```

### å•Ÿç”¨/åœç”¨ç‰¹å®šä»»å‹™

ä½¿ç”¨å‘½ä»¤åˆ—åƒæ•¸ï¼š

```bash
# åªåŸ·è¡Œ karma ä»»å‹™ï¼ˆä¸åŸ·è¡Œ rankingsï¼‰
npm run cron:karma
pm2 start ecosystem.config.js --only cron-manager -- --karma-only

# åªåŸ·è¡Œ rankings ä»»å‹™ï¼ˆä¸åŸ·è¡Œ karmaï¼‰
npm run cron:rankings
pm2 start ecosystem.config.js --only cron-manager -- --rankings-only
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### ä»»å‹™æ²’æœ‰åŸ·è¡Œ

#### 1. æª¢æŸ¥ç¨‹åºæ˜¯å¦é‹è¡Œ

```bash
pm2 status
```

æ‡‰è©²çœ‹åˆ° `cron-manager` ç‹€æ…‹ç‚º `online`ã€‚

#### 2. æŸ¥çœ‹æ—¥èªŒ

```bash
pm2 logs cron-manager --lines 50
```

æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯ã€‚

#### 3. æª¢æŸ¥ç’°å¢ƒè®Šæ•¸

```bash
pm2 show cron-manager
```

ç¢ºèªç’°å¢ƒè®Šæ•¸æ­£ç¢ºè¨­å®šã€‚

### è¨˜æ†¶é«”ä½¿ç”¨éé«˜

#### 1. æŸ¥çœ‹è¨˜æ†¶é«”ä½¿ç”¨

```bash
pm2 monit
```

#### 2. é™ä½è¨˜æ†¶é«”é™åˆ¶è§¸ç™¼é‡å•Ÿ

ç·¨è¼¯ `ecosystem.config.js`ï¼š

```javascript
max_memory_restart: "500M"; // é™ä½åˆ° 500MB
```

#### 3. é‡å•Ÿæœå‹™

```bash
pm2 restart cron-manager
```

### ä»»å‹™åŸ·è¡Œå¤±æ•—

#### 1. æŸ¥çœ‹éŒ¯èª¤æ—¥èªŒ

```bash
pm2 logs cron-manager --err --lines 100
```

#### 2. æ‰‹å‹•åŸ·è¡Œæ¸¬è©¦

```bash
npm run cron:once
```

#### 3. æª¢æŸ¥è³‡æ–™åº«é€£æ¥

ç¢ºèª `.env.local` ä¸­çš„è³‡æ–™åº«è¨­å®šæ­£ç¢ºã€‚

---

## ğŸ“ˆ æ•ˆèƒ½æ¯”è¼ƒ

### è¨˜æ†¶é«”ä½¿ç”¨

| æ–¹æ¡ˆ                     | ç¨‹åºæ•¸   | è¨˜æ†¶é«”ä½¿ç”¨         |
| ------------------------ | -------- | ------------------ |
| ç¨ç«‹è…³æœ¬                 | 3 å€‹     | ~600MB (3 Ã— 200MB) |
| **Unified Cron Manager** | **1 å€‹** | **~250MB**         |
| **ç¯€çœ**                 | **-66%** | **~350MB**         |

### CPU ä½¿ç”¨

- ç¨ç«‹è…³æœ¬ï¼š3 å€‹ç¨‹åºç«¶çˆ­ CPU æ™‚é–“
- Unified Cron Managerï¼šå–®ä¸€ç¨‹åºï¼Œæ›´é«˜æ•ˆçš„è³‡æºä½¿ç”¨

### æ—¥èªŒç®¡ç†

- ç¨ç«‹è…³æœ¬ï¼š3 å€‹æ—¥èªŒæª”æ¡ˆ
- Unified Cron Managerï¼š1 å€‹æ—¥èªŒæª”æ¡ˆï¼Œæ›´å®¹æ˜“è¿½è¹¤

---

## ğŸ¯ æœ€ä½³å¯¦è¸

### 1. ä½¿ç”¨ PM2 ç®¡ç†

âœ… æ¨è–¦ä½¿ç”¨ PM2 è€Œéæ‰‹å‹•åŸ·è¡Œ  
âœ… è¨­å®šé–‹æ©Ÿè‡ªå‹•å•Ÿå‹•  
âœ… å®šæœŸæª¢æŸ¥æ—¥èªŒ

### 2. ç›£æ§è¨˜æ†¶é«”å’Œ CPU

```bash
# å®šæœŸæª¢æŸ¥
pm2 monit

# æˆ–ä½¿ç”¨ç³»çµ±ç›£æ§å·¥å…·
htop
```

### 3. å®šæœŸå‚™ä»½æ—¥èªŒ

```bash
# æ¯é€±å‚™ä»½ä¸€æ¬¡
tar -czf logs-backup-$(date +%Y%m%d).tar.gz logs/
```

### 4. è¨­å®šå‘Šè­¦é€šçŸ¥

å¯ä»¥æ•´åˆ PM2 çš„é€šçŸ¥åŠŸèƒ½ï¼š

```bash
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
```

---

## ğŸ†š èˆ‡å…¶ä»–æ–¹æ¡ˆæ¯”è¼ƒ

### vs. Supabase Cron Jobs (pg_cron)

| ç‰¹æ€§     | Cron Manager       | pg_cron              |
| -------- | ------------------ | -------------------- |
| è²»ç”¨     | âœ… å…è²»            | âŒ éœ€è¦ Pro ($25/æœˆ) |
| å½ˆæ€§     | âœ… å¯è‡ªè¨‚é »ç‡      | âš ï¸ å—é™æ–¼ SQL        |
| ç›£æ§     | âœ… è©³ç´°çµ±è¨ˆ        | âš ï¸ åŸºæœ¬æ—¥èªŒ          |
| éŒ¯èª¤è™•ç† | âœ… å®Œæ•´æ§åˆ¶        | âš ï¸ æœ‰é™              |
| éƒ¨ç½²     | âš ï¸ éœ€è¦ PM2/Docker | âœ… å…§å»º              |

### vs. Vercel Cron Jobs

| ç‰¹æ€§         | Cron Manager | Vercel Cron      |
| ------------ | ------------ | ---------------- |
| è²»ç”¨         | âœ… å…è²»      | âœ… å…è²»          |
| åŸ·è¡Œæ™‚é–“é™åˆ¶ | âœ… ç„¡é™åˆ¶    | âŒ 10 ç§’ (Hobby) |
| é »ç‡é™åˆ¶     | âœ… ç„¡é™åˆ¶    | âš ï¸ æ¯å¤©æœ‰é™      |
| æœ¬åœ°æ¸¬è©¦     | âœ… å®¹æ˜“      | âš ï¸ å›°é›£          |
| çµ±è¨ˆè³‡è¨Š     | âœ… è©³ç´°      | âš ï¸ åŸºæœ¬          |

---

## ğŸ“ ç¸½çµ

Unified Cron Manager æä¾›ï¼š

âœ… **å–®ä¸€ç¨‹åºç®¡ç†**ï¼šæ¸›å°‘è³‡æºä½¿ç”¨  
âœ… **çµ±ä¸€ç›£æ§**ï¼šé›†ä¸­çš„æ—¥èªŒå’Œçµ±è¨ˆ  
âœ… **éˆæ´»é…ç½®**ï¼šå¯è‡ªè¨‚åŸ·è¡Œé »ç‡  
âœ… **å…è²»æ–¹æ¡ˆ**ï¼šé©åˆ Supabase Free Tier  
âœ… **æ˜“æ–¼éƒ¨ç½²**ï¼šä½¿ç”¨ PM2 ä¸€éµå•Ÿå‹•  
âœ… **è©³ç´°çµ±è¨ˆ**ï¼šè¿½è¹¤æ¯å€‹ä»»å‹™çš„åŸ·è¡Œç‹€æ³

æ¨è–¦ç”¨æ–¼ç”Ÿç”¢ç’°å¢ƒï¼
